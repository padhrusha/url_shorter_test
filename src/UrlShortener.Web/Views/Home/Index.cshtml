@model UrlShortener.Web.Models.UrlListViewModel

@{
    ViewData["Title"] = "Home";
}

<h1 class="mb-4">Сокращенный URL</h1>

<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Введите URL для сокращения</h5>
        <form asp-action="Create" method="post">
            <div class="input-group">
                <input type="url" class="form-control @(ViewData.ModelState["NewUrl.OriginalUrl"]?.Errors.Count > 0 ? "is-invalid" : "")"
                       asp-for="NewUrl.OriginalUrl"
                       pattern="https?://[^/]+\.[a-zA-Z]{2,}(/.*)?"
                       placeholder="https://example.com/very/long/url" />
                <button type="submit" class="btn btn-primary" id="shortenBtn" disabled>Сократить</button>
                <div class="invalid-feedback">
                    @Html.ValidationMessageFor(m => m.NewUrl.OriginalUrl)
                </div>
            </div>
        </form>
    </div>
</div>

@if (Model.Urls.Count > 0)
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Длинный URL</th>
                    <th>Сокращенный URL</th>
                    <th>Дата создания</th>
                    <th>Количество кликов</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var url in Model.Urls)
                {
                    <tr>
                        <td class="text-truncate" style="max-width: 300px;">
                            <a href="@url.OriginalUrl" target="_blank" rel="noopener noreferrer"
                               title="@url.OriginalUrl">@url.OriginalUrl</a>
                        </td>
                        <td>
                            <a href="@url.ShortUrl" target="_blank" rel="noopener noreferrer"
                               onclick="incrementClick(this)">@url.ShortUrl</a>
                        </td>
                        <td>@url.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                        <td class="click-count">@url.ClickCount</td>
                        <td>
                            <a asp-action="Edit" asp-route-id="@url.Id" class="btn btn-sm btn-outline-primary">Редактировать</a>
                            <form asp-action="Delete" asp-route-id="@url.Id" method="post" class="d-inline"
                                  onsubmit="return confirm('Удалить эту запись URL?');">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-sm btn-outline-danger">Удалить</button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info">Нет сокращенных URLs еще. Создай ниже!</div>
}

@section Scripts {
    <script>
        function incrementClick(link) {
            const row = link.closest('tr');
            const countCell = row.querySelector('.click-count');
            countCell.textContent = parseInt(countCell.textContent) + 1;
        }

        const urlInput = document.getElementById('NewUrl_OriginalUrl');
        const shortenBtn = document.getElementById('shortenBtn');

        urlInput.addEventListener('input', function () {
            shortenBtn.disabled = !urlInput.checkValidity() || !urlInput.value;
        });
    </script>
}
